<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>JujuWeb — Video Editor</title>

  <style>
    :root{
      --bg:#0f1724;
      --card:#131c2e;
      --accent:#4f46e5;
      --muted:#9aa4b2;
      font-family: Inter, -apple-system, system-ui;
      color-scheme: dark;
    }
    body{
      margin:0;
      background:#071121;
      color:#e6eef6;
    }
    .container{
      max-width:1000px;
      margin:auto;
      padding:18px;
    }
    h1{margin:0;font-size:22px;}
    .subtitle{color:var(--muted);font-size:13px;margin-top:4px;}

    .card{
      background:var(--card);
      border-radius:14px;
      padding:18px;
      margin-top:18px;
      box-shadow:0 6px 18px rgba(0,0,0,0.5);
    }

    /* SAFARI FIX */
    *{ -webkit-tap-highlight-color:transparent; }
    input, button, .upload-area{ touch-action: manipulation; }

    .flex{
      display:flex;
      gap:16px;
    }
    @media(max-width:850px){
      .flex{flex-direction:column;}
    }

    /* Upload Area */
    .upload-area{
      border:2px dashed rgba(255,255,255,0.2);
      padding:28px;
      border-radius:14px;
      text-align:center;
      position:relative;
      cursor:pointer;
      margin-bottom:12px;
      user-select:none;
    }

    /* SAFARI input fix: full click area */
    #fileInput{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      opacity:0;
      cursor:pointer;
      z-index:9999;
    }

    video{
      width:100%;
      max-height:260px;
      border-radius:10px;
      background:black;
      margin-top:14px;
    }

    label{
      display:block;
      margin-top:12px;
      font-size:14px;
      font-weight:600;
    }

    input, select{
      width:100%;
      padding:10px;
      background:rgba(255,255,255,0.08);
      color:white;
      border:none;
      border-radius:8px;
      margin-top:4px;
      font-size:14px;
    }

    .btn{
      margin-top:16px;
      width:100%;
      padding:12px;
      border:none;
      border-radius:10px;
      font-weight:700;
      background:var(--accent);
      color:white;
      cursor:pointer;
    }

    .progress{
      height:12px;
      background:rgba(255,255,255,0.1);
      border-radius:999px;
      overflow:hidden;
      margin-top:12px;
    }
    .progress i{
      height:100%;
      width:0%;
      background:linear-gradient(90deg,#7fa7ff,#4f46e5);
      display:block;
    }

    #log{
      height:300px;
      background:rgba(0,0,0,0.25);
      padding:12px;
      border-radius:12px;
      overflow:auto;
      font-family:monospace;
      font-size:13px;
    }
  </style>
</head>

<body>
<div class="container">

  <h1>JujuWeb — Video Editor</h1>
  <div class="subtitle">Trim & Tambah Teks • Berjalan 100% di Browser</div>

  <div class="card">
    <div class="flex">

      <!-- LEFT SIDE -->
      <div style="flex:1">

        <div class="upload-area" id="uploadArea">
          <div style="font-weight:700;font-size:16px">Tarik & lepas videomu di sini</div>
          <div style="font-size:13px;color:var(--muted)">Atau ketuk untuk pilih (Safari FIX)</div>

          <input id="fileInput" type="file" accept="video/*">
        </div>

        <!-- Editor will appear here -->
        <div id="editor" style="display:none">

          <video id="video" controls></video>

          <label>Start (detik)</label>
          <input id="startSec" type="number" step="0.1" value="0">

          <label>End (detik)</label>
          <input id="endSec" type="number" step="0.1" value="5">

          <label>Teks Overlay</label>
          <input id="overlayText" placeholder="Masukkan teks...">

          <label>Posisi Teks</label>
          <select id="overlayPos">
            <option value="10:10">Kiri Atas</option>
            <option value="10:main_h-40">Kiri Bawah</option>
            <option value="main_w-10:10">Kanan Atas</option>
            <option value="main_w-10:main_h-40">Kanan Bawah</option>
          </select>

          <button class="btn" id="btnExport">Export Video</button>

          <div class="progress">
            <i id="progressBar"></i>
          </div>

          <div id="status" style="margin-top:6px;font-size:13px;color:var(--muted)">Menunggu...</div>
        </div>

      </div>

      <!-- RIGHT SIDE -->
      <div style="flex:1">
        <label style="font-size:14px;font-weight:700">Log & Tips</label>
        <div id="log"></div>
      </div>

    </div>
  </div>

</div>


<!-- FFmpeg -->
<script type="module">
  import { createFFmpeg, fetchFile } 
    from "https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.11.7/dist/ffmpeg.min.js";

  const video = document.getElementById("video");
  const editor = document.getElementById("editor");
  const log = document.getElementById("log");
  const statusEl = document.getElementById("status");
  const progressBar = document.getElementById("progressBar");
  const fileInput = document.getElementById("fileInput");

  let ffmpeg = null;
  let currentFile = null;

  const addLog = txt => {
    log.innerHTML += txt + "<br>";
    log.scrollTop = log.scrollHeight;
  };

  /* FILE UPLOAD FIX */
  fileInput.addEventListener("change", e => {
    const file = e.target.files[0];
    if (!file) return;

    currentFile = file;
    video.src = URL.createObjectURL(file);
    video.load();

    editor.style.display = "block";
    addLog("Video dipilih: " + file.name);
  });

  async function loadFFmpeg() {
    if (ffmpeg) return ffmpeg;

    addLog("Memuat FFmpeg...");
    statusEl.textContent = "Memuat FFmpeg...";

    ffmpeg = createFFmpeg({
      log: true,
      corePath:
        "https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.11.1/dist/ffmpeg-core.js"
    });

    ffmpeg.setProgress(({ ratio }) => {
      progressBar.style.width = Math.round(ratio * 100) + "%";
    });

    await ffmpeg.load();
    addLog("FFmpeg siap.");
    return ffmpeg;
  }

  document.getElementById("btnExport").onclick = async () => {
    if (!currentFile) return alert("Upload video terlebih dahulu!");

    await loadFFmpeg();

    const s = parseFloat(document.getElementById("startSec").value);
    const e = parseFloat(document.getElementById("endSec").value);
    const dur = e - s;

    const txt = document.getElementById("overlayText").value.trim();
    const pos = document.getElementById("overlayPos").value;

    statusEl.textContent = "Menulis file...";
    addLog("Menulis input.mp4");

    ffmpeg.FS("writeFile","input.mp4",await fetchFile(currentFile));

    let args = ["-ss",String(s),"-i","input.mp4","-t",String(dur)];

    if (txt){
      const esc = txt.replace(/[:\\']/g,m=>'\\'+m);
      args.push(
        "-vf",
        `drawtext=text='${esc}':x=${pos.split(":")[0]}:y=${pos.split(":")[1]}:fontsize=32:fontcolor=white:box=1:boxcolor=0x00000099`
      );
    }

    args.push("-c:v","libx264","-preset","veryfast","-c:a","aac","output.mp4");

    addLog("Memproses video...");
    await ffmpeg.run(...args);

    addLog("Mengambil output...");
    const data = ffmpeg.FS("readFile","output.mp4");
    const blob = new Blob([data.buffer], {type:"video/mp4"});
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "juju-output.mp4";
    a.click();

    statusEl.textContent = "Selesai!";
    addLog("Export selesai.");
  };
</script>

</body>
</html>
